import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Setup your front end

## Deep linking

When we send out a passkey email, the link will redirect to your application specified by the Authenticator Config's [Invoke URL](../platform-overview/authenticator-config#invoke-url). This URI should either be an app scheme or a Universal URL / App link.

:::caution
While app schemes are generally easier to set up, Universal URLs and App Links are recommended as they provide protection against App Scheme hijacking.
:::

<Tabs groupId="bind-platform">
<TabItem value="kotlin" label="Kotlin">

Android supports two ways of deep linking into an application. Pick one of the following and follow the guide:

- [Custom Schemes](https://developer.android.com/training/basics/intents/filters)
- [App Links](https://developer.android.com/training/app-links)

</TabItem>
<TabItem value="swift" label="Swift">

Apple supports two ways of deep linking into an application. Pick one of the following and follow the guide:

- [App Schemes](https://developer.apple.com/documentation/xcode/defining-a-custom-url-scheme-for-your-app)
- [Universal URLs](https://developer.apple.com/library/archive/documentation/General/Conceptual/AppSearch/UniversalLinks.html)

</TabItem>
<TabItem value="reactnative" label="React Native">

If you are using Expo, follow the [deep linking guide](https://docs.expo.dev/guides/deep-linking/).

If you are using a `bare expo` or `react-native init` project, follow the Kotlin and Swift guides to setting up deep linking on React Native.

Also check out [React Native Linking](https://reactnative.dev/docs/linking):

```javascript
import { useEffect, useState } from 'react';
import { Linking } from 'react-native';

export default function useDeepLinkURL() {
  const [linkedURL, setLinkedURL] = (useState < string) | (null > null);

  // If the app is not already open
  useEffect(() => {
    const getUrlAsync = async () => {
      const initialUrl = await Linking.getInitialURL();
      if (initialUrl !== null) {
        setLinkedURL(decodeURI(initialUrl));
      }
    };

    getUrlAsync();
  }, []);

  // If the app is already open
  useEffect(() => {
    const callback = ({ url }: { url: string }) => setLinkedURL(decodeURI(url));
    const linkingEventListener = Linking.addEventListener('url', callback);
    return () => {
      linkingEventListener.remove();
    };
  }, []);

  return { linkedURL };
}

// in App.js
const { linkedURL } = useDeepLinkURL();

useEffect(() => {
  async function register() {
    if (linkedURL !== null) {
      console.log('intercepted:', linkedURL);
    }
  }

  register();
}, [linkedURL]);
```

</TabItem>
<TabItem value="flutter" label="Flutter">
Follow the Kotlin and Swift guides to setting up deep linking on Flutter.

</TabItem>
</Tabs>

## Handle link in the SDK

The binding link that is redirected to your application will take on the following form. A `/bind` path will be appended to your Invoke URL as well as several other query parameters. Use a "/bind" route to intercept this url in your application:

```
$invoke_url/bind?api_base_url=<api_base_url>&tenant_id=<tenant_id>&realm_id=<realm_id>&identity_id=<identity_id>&job_id=<job_id>&token=<token>
```

Once you receive the incoming URL, pass it into the SDK to complete the binding process.

Upon success, a private key will have been created in the device's hardware trust module and the corresponding public key will have been sent to the Beyond Identity Cloud. At this point the user has a passkey enrolled on this device. Don't forget to initalize your SDK ahead of time. For more information see [SDK Setup](./sdk-setup).

<Tabs groupId="bind-platform">
<TabItem value="javascript" label="Javascript">

:::tip NextAuth.js
This guide uses [NextAuth](https://next-auth.js.org/) for all OAuth/OIDC flows. All code snippets are provided in the context of the [NextAuth Example App](https://github.com/nextauthjs/next-auth-example). Note that your application must be set up as a confidential application.
:::

Create a `bind.tsx` page under `/next-auth-example/pages`. As long as your `Invoke URL` is configured properly in your [Authenticator Config](../platform-overview/authenticator-config), this is the page that will be redirected to during an authorization flow. Copy the following code snippet into that page.

```javascript
import { useEffect, useState } from 'react';
import 'bootstrap/dist/css/bootstrap.css';

const BindPasskeyFromRedirect = () => {
  const [bindPasskeyResult, setBindPasskeyResult] = useState('');

  useEffect(() => {
    // -- 1
    const bindPasskey = async () => {
      const BeyondIdentityEmbeddedSdk = await import(
        '@beyondidentity/bi-sdk-js'
      );
      let embedded = await BeyondIdentityEmbeddedSdk.Embedded.initialize();
      // -- 2
      if (embedded.isBindPasskeyUrl(window.location.href)) {
        // Only bind if the URL is a "bind" URL
        let bindPasskeyUrl = window.location.href;
        // -- 3
        embedded
          .bindPasskey(bindPasskeyUrl)
          .then(setBindPasskeyResult)
          .catch((error) => {
            setBindPasskeyResult(error.toString());
          });
      }
    };

    bindPasskey().catch(console.error);
  }, []);

  return (
    <div
      style={{
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        height: '100vh',
      }}
    >
      <div className="container">
        <div className="row">
          {bindPasskeyResult.length > 0 && (
            <div className="row row-cols-1 row-cols-md-1 mt-3">
              <div className="col">
                {JSON.stringify(bindPasskeyResult, null, 2)}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default BindPasskeyFromRedirect;
```

What's happening here?

1. The `useEffect` is only called once on page load. In this function, we initialize the Beyond Identity SDK and use `embedded.isBindPasskeyUrl` to check if the current page that was redirected to is in fact a valid `bind` URL.
2. If the URL is valid, we pull the URL using `window.location.href` and pass that directly into `embedded.bindPasskey`.
3. `embedded.bindPasskey` completes the binding process and stores a passkey in the user's browser.

</TabItem>
<TabItem value="kotlin" label="Kotlin">

You can validate the incoming URL with `isBindPasskeyUrl`. When the URL is intercepted, pass it to `bindPasskey`.

```kotlin
if (EmbeddedSdk.isBindPasskeyUrl(url)) {
    EmbeddedSdk.bindPasskey(url = bindingLink)
    .onEach { result ->
        result.onSuccess { success ->
            Timber.d("Bind Passkey success = $success")
        }
        result.onFailure { failure ->
            Timber.e("Bind Passkey failure = $failure")
        }
    }
}
```

</TabItem>
<TabItem value="swift" label="Swift">

Catch a url from your AppDelegate or SceneDelegate. You can validate the incoming URL with `isBindPasskeyUrl`. When the URL is intercepted, pass it to `bindPasskey`.

```swift
func scene(_ scene: UIScene, openURLContexts URLContexts: Set<UIOpenURLContext>) {
    if let url = URLContexts.first?.url, Embedded.shared.isBindPasskeyUrl(url) {
        Embedded.shared.bindPasskey(url: bindingLink) { result in
            switch result {
            case let .success(bindResponse):
                print(bindResponse)
            case let .failure(error):
                print(error.localizedDescription)
            }
        }
    }
}
```

</TabItem>
<TabItem value="reactnative" label="React Native">

You can validate the incoming URL with `isBindPasskeyUrl`. When the URL is intercepted, pass it to `bindPasskey`.

```javascript
const isBindUrl = await Embedded.isBindPasskeyUrl(url);
if (isBindUrl) {
  const bindResponse = await Embedded.bindPasskey(bindingLink);
  console.log(bindResponse);
}
```

</TabItem>
<TabItem value="flutter" label="Flutter">

You can validate the incoming URL with `isBindPasskeyUrl`. When the URL is intercepted, pass it to `bindPasskey`.

```dart
bool isBindUrl = await EmbeddedSdk.isBindPasskeyUrl(bindingLink);

if (isBindUrl) {
    BindPasskeyResponse bindResponse = await EmbeddedSdk.bindPasskey(bindingLink);
    debugPrint(bindResponse);
}
```

</TabItem>
</Tabs>
